---
import BaseLayout from '../layouts/BaseLayout.astro';
import partnersData from '../data/buwatv/partners.json';

const title = "Locations | BuWa Digital";
const description = "Find BuWa TV screens at popular locations throughout the community.";

const hostPartners = partnersData.hostPartners ?? partnersData.partners ?? [];
const communityPartners = partnersData.communityPartners ?? [];

const normalizePartnerName = (value = '') =>
  value
    .toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

const uniquePartners = (items = []) => {
  const seen = new Set();
  return items.filter((partner) => {
    const key = normalizePartnerName(partner?.name ?? '');
    if (!key || seen.has(key)) return false;
    seen.add(key);
    return true;
  });
};

const partners = uniquePartners([
  ...hostPartners.map((partner) => ({
    name: partner.name,
    src: partner.logo ? `/uploads/partners/${partner.logo}` : ''
  })),
  ...communityPartners.map((partner) => ({
    name: partner.name,
    src: partner.logo ? `/uploads/partners/${partner.logo}` : ''
  }))
]).filter((partner) => partner.name && partner.src);

const partnerCount = partners.length;
---

<BaseLayout title={title} description={description}>
  <section class="hero">
    <div class="container">
      <h1>Our Network Partners</h1>
      <p class="subtitle"><strong>Check out where you could be seen in the community.</strong></p>
      <a href="/contact-us/" class="btn btn-cta">
        <i class="fa-solid fa-paper-plane"></i> Get In Touch
      </a>
    </div>
  </section>

  <section class="locations-section">
    <div class="container">
      <h2>Our Locations</h2>
      <p class="intro">Our screens can be found in many popular locations throughout the community. Our screens offer a unique format - keeping you in front of your customers in your business, even when other ads are playing.</p>
      
      <div class="map-container">
        <iframe 
          src="https://www.google.com/maps/d/embed?mid=1XGVatlmUL7p9iJ9cFjk7LxkEtQXPdrI&ehbc=2E312F" 
          width="100%" 
          height="480"
          style="border:0;"
          allowfullscreen=""
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      </div>
    </div>
  </section>

  <section class="partners-section">
    <div class="container">
      <h2>Our Partners</h2>
    </div>
    <div class="carousel-wrapper">
      <div class="carousel-track" data-partner-count={partnerCount}>
        {partners.map(partner => (
          <div class="carousel-item">
            <img src={partner.src} alt={partner.name} loading="lazy" />
          </div>
        ))}
        {partners.map(partner => (
          <div class="carousel-item">
            <img src={partner.src} alt={partner.name} loading="lazy" />
          </div>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .hero {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 3rem 2rem 4rem;
    text-align: center;
    color: white;
    position: relative;
    overflow: hidden;
  }
  
  .hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      135deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.02) 10px,
      rgba(255,255,255,0.02) 20px
    );
    pointer-events: none;
  }
  
  .hero .container {
    position: relative;
    z-index: 1;
  }
  
  .hero h1 {
    font-family: 'Inter', sans-serif;
    font-size: 2.5rem;
    margin-bottom: 1rem;
  }
  
  .hero .subtitle {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    color: rgba(255,255,255,0.9);
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  
  .btn-cta {
    background: linear-gradient(180deg, #c42536 0%, #a01c2b 100%);
    color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .btn-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  
  .locations-section {
    padding: 4rem 0;
    background: #f8f9fa;
  }
  
  .locations-section h2 {
    font-family: 'Inter', sans-serif;
    font-size: 2rem;
    color: #1a1a2e;
    margin-bottom: 1rem;
    text-align: center;
  }
  
  .locations-section .intro {
    text-align: center;
    max-width: 800px;
    margin: 0 auto 2rem;
    color: #4a5568;
    line-height: 1.7;
  }
  
  .map-container {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  }
  
  .partners-section {
    padding: 4rem 0;
    background: white;
    overflow: hidden;
  }
  
  .partners-section h2 {
    font-family: 'Inter', sans-serif;
    font-size: 2rem;
    color: #1a1a2e;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .carousel-wrapper {
    overflow: hidden;
    width: 100%;
  }
  
  .carousel-track {
    display: flex;
    width: max-content;
  }
  
  .carousel-item {
    flex: 0 0 180px;
    height: 144px;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
  }
  
  .carousel-item img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: grayscale(20%);
    opacity: 0.85;
    transition: all 0.3s ease;
  }
  
  .carousel-item img:hover {
    filter: grayscale(0%);
    opacity: 1;
    transform: scale(1.05);
  }
  
  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2rem;
    }
    
    .carousel-item {
      flex: 0 0 140px;
      height: 120px;
    }
  }
</style>

<script>
  // Smooth infinite carousel with calculated scroll distance
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.querySelector('.carousel-track');
    if (!track) return;
    
    const partnerCount = parseInt(track.dataset.partnerCount) || 25;
    const items = track.querySelectorAll('.carousel-item');
    
    // Wait for images to load to get accurate measurements
    const images = track.querySelectorAll('img');
    let loadedCount = 0;
    
    const initCarousel = () => {
      // Calculate the width of the first set of items (half the track)
      const itemWidth = items[0].offsetWidth;
      const scrollDistance = itemWidth * partnerCount;
      
      // Calculate duration based on number of items (roughly 1.2 seconds per item)
      const duration = partnerCount * 1.2;
      
      // Create and inject the animation
      const styleSheet = document.createElement('style');
      styleSheet.textContent = `
        @keyframes smoothScroll {
          0% { transform: translateX(0); }
          100% { transform: translateX(-${scrollDistance}px); }
        }
        .carousel-track {
          animation: smoothScroll ${duration}s linear infinite;
        }
        .carousel-track:hover {
          animation-play-state: paused;
        }
      `;
      document.head.appendChild(styleSheet);
    };
    
    // Initialize after all images load, or after 2 seconds (whichever comes first)
    const checkLoaded = () => {
      loadedCount++;
      if (loadedCount >= images.length) {
        initCarousel();
      }
    };
    
    images.forEach(img => {
      if (img.complete) {
        checkLoaded();
      } else {
        img.addEventListener('load', checkLoaded);
        img.addEventListener('error', checkLoaded);
      }
    });
    
    // Fallback: initialize after 2 seconds regardless
    setTimeout(() => {
      if (!document.querySelector('style[data-carousel]')) {
        initCarousel();
      }
    }, 2000);
  });
</script>
